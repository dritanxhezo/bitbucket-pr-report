package net.ngeor.bprr;

import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonStreamParser;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.PrintWriter;

public class DemoServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String accessToken = (String)req.getSession().getAttribute("accessToken");
// move jsp to WEB-INF to hide it and then do MVC
//        RequestDispatcher requestDispatcher = getServletContext().getRequestDispatcher("/WEB-INF/some.jsp");
//        req.setAttribute("bean", bean);
//        requestDispatcher.forward(req, resp);
        PrintWriter out = resp.getWriter();
        try {
            out.println(accessToken);
            test(out, accessToken);
        } finally {
            out.flush();
            out.close();
        }
    }

    private void test(PrintWriter out, String accessToken) throws IOException {
        if (accessToken == null) {
            throw new IllegalStateException("No accessToken!");
        }
        CloseableHttpClient httpClient = HttpClients.createDefault();
        try {
            HttpGet httpGet = new HttpGet("https://api.bitbucket.org/2.0/repositories/" + Settings.getInstance().getUser() + "?access_token=" + accessToken);
            CloseableHttpResponse httpResponse = httpClient.execute(httpGet);
            try {
                out.println(httpResponse.getStatusLine().getStatusCode());
                InputStream content = httpResponse.getEntity().getContent();
                InputStreamReader reader = new InputStreamReader(content);
                JsonStreamParser p = new JsonStreamParser(reader);
                /*
                {"pagelen":10,"values":[{"scm":"git","website":null,"has_wiki":false,"name":"Build Suite","links":{"watchers":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/build-suite/watchers"},"branches":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/build-suite/refs/branches"},"tags":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/build-suite/refs/tags"},"commits":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/build-suite/commits"},"clone":[{"href":"https://ngeor@bitbucket.org/ngeor/build-suite.git","name":"https"},{"href":"ssh://git@bitbucket.org/ngeor/build-suite.git","name":"ssh"}],"self":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/build-suite"},"html":{"href":"https://bitbucket.org/ngeor/build-suite"},"avatar":{"href":"https://bitbucket.org/ngeor/build-suite/avatar/32/"},"hooks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/build-suite/hooks"},"forks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/build-suite/forks"},"downloads":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/build-suite/downloads"},"pullrequests":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/build-suite/pullrequests"}},"fork_policy":"no_public_forks","uuid":"{5b120c07-40b7-4352-b796-9afba1887af3}","language":"javascript","created_on":"2014-12-01T14:30:18.775867+00:00","parent":{"links":{"self":{"href":"https://api.bitbucket.org/2.0/repositories/demandware/build-suite-ant"},"html":{"href":"https://bitbucket.org/demandware/build-suite-ant"},"avatar":{"href":"https://bitbucket.org/demandware/build-suite-ant/avatar/32/"}},"type":"repository","name":"Build Suite Ant","full_name":"demandware/build-suite-ant","uuid":"{4db1b469-3ce3-4370-8914-a6269e344c74}"},"full_name":"ngeor/build-suite","has_issues":false,"owner":{"username":"ngeor","display_name":"Nikolaos Georgiou","type":"user","uuid":"{b035c98c-8f83-49d0-8770-95c80cc24dc5}","links":{"self":{"href":"https://api.bitbucket.org/2.0/users/ngeor"},"html":{"href":"https://bitbucket.org/ngeor/"},"avatar":{"href":"https://bitbucket.org/account/ngeor/avatar/32/"}}},"updated_on":"2014-12-01T15:01:07.789578+00:00","size":98147735,"type":"repository","is_private":true,"description":"Forking to resolve missing parenthesis bug in file bundling"},{"scm":"git","website":null,"has_wiki":false,"name":"GruntTasks","links":{"watchers":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/grunttasks/watchers"},"branches":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/grunttasks/refs/branches"},"tags":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/grunttasks/refs/tags"},"commits":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/grunttasks/commits"},"clone":[{"href":"https://ngeor@bitbucket.org/ngeor/grunttasks.git","name":"https"},{"href":"ssh://git@bitbucket.org/ngeor/grunttasks.git","name":"ssh"}],"self":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/grunttasks"},"html":{"href":"https://bitbucket.org/ngeor/grunttasks"},"avatar":{"href":"https://bitbucket.org/ngeor/grunttasks/avatar/32/"},"hooks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/grunttasks/hooks"},"forks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/grunttasks/forks"},"downloads":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/grunttasks/downloads"},"pullrequests":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/grunttasks/pullrequests"}},"fork_policy":"allow_forks","uuid":"{78f5e944-75b0-471f-b7d0-02bdbe5694ff}","language":"","created_on":"2014-12-09T10:03:07.835605+00:00","parent":{"links":{"self":{"href":"https://api.bitbucket.org/2.0/repositories/jmatos/grunttasks"},"html":{"href":"https://bitbucket.org/jmatos/grunttasks"},"avatar":{"href":"https://bitbucket.org/jmatos/grunttasks/avatar/32/"}},"type":"repository","name":"GruntTasks","full_name":"jmatos/grunttasks","uuid":"{88e76433-3515-4168-aa8b-a41e4b4669d6}"},"full_name":"ngeor/grunttasks","has_issues":false,"owner":{"username":"ngeor","display_name":"Nikolaos Georgiou","type":"user","uuid":"{b035c98c-8f83-49d0-8770-95c80cc24dc5}","links":{"self":{"href":"https://api.bitbucket.org/2.0/users/ngeor"},"html":{"href":"https://bitbucket.org/ngeor/"},"avatar":{"href":"https://bitbucket.org/account/ngeor/avatar/32/"}}},"updated_on":"2015-06-30T08:34:15.735629+00:00","size":11428379,"type":"repository","is_private":false,"description":""},{"scm":"git","website":"","has_wiki":false,"name":"StorefrontBrowser","links":{"watchers":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/storefrontbrowser/watchers"},"branches":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/storefrontbrowser/refs/branches"},"tags":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/storefrontbrowser/refs/tags"},"commits":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/storefrontbrowser/commits"},"clone":[{"href":"https://ngeor@bitbucket.org/ngeor/storefrontbrowser.git","name":"https"},{"href":"ssh://git@bitbucket.org/ngeor/storefrontbrowser.git","name":"ssh"}],"self":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/storefrontbrowser"},"html":{"href":"https://bitbucket.org/ngeor/storefrontbrowser"},"avatar":{"href":"https://bitbucket.org/ngeor/storefrontbrowser/avatar/32/"},"hooks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/storefrontbrowser/hooks"},"forks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/storefrontbrowser/forks"},"downloads":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/storefrontbrowser/downloads"},"pullrequests":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/storefrontbrowser/pullrequests"}},"fork_policy":"no_public_forks","uuid":"{29562ed7-c788-4907-8dbe-8b49074c3449}","language":"android","created_on":"2015-01-10T19:58:05.248972+00:00","full_name":"ngeor/storefrontbrowser","has_issues":false,"owner":{"username":"ngeor","display_name":"Nikolaos Georgiou","type":"user","uuid":"{b035c98c-8f83-49d0-8770-95c80cc24dc5}","links":{"self":{"href":"https://api.bitbucket.org/2.0/users/ngeor"},"html":{"href":"https://bitbucket.org/ngeor/"},"avatar":{"href":"https://bitbucket.org/account/ngeor/avatar/32/"}}},"updated_on":"2015-02-16T17:35:37.832166+00:00","size":415121,"type":"repository","is_private":true,"description":"Example storefront browser using Demandware OCAPI."},{"scm":"git","website":null,"has_wiki":false,"name":"dmw","links":{"watchers":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/dmw/watchers"},"branches":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/dmw/refs/branches"},"tags":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/dmw/refs/tags"},"commits":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/dmw/commits"},"clone":[{"href":"https://ngeor@bitbucket.org/ngeor/dmw.git","name":"https"},{"href":"ssh://git@bitbucket.org/ngeor/dmw.git","name":"ssh"}],"self":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/dmw"},"html":{"href":"https://bitbucket.org/ngeor/dmw"},"avatar":{"href":"https://bitbucket.org/ngeor/dmw/avatar/32/"},"hooks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/dmw/hooks"},"forks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/dmw/forks"},"downloads":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/dmw/downloads"},"pullrequests":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/dmw/pullrequests"}},"fork_policy":"no_public_forks","uuid":"{d87f89ad-7568-4465-8c87-badd02a019bc}","language":"","created_on":"2015-01-12T10:09:22.933111+00:00","parent":{"links":{"self":{"href":"https://api.bitbucket.org/2.0/repositories/bestseller-ecom/dmw"},"html":{"href":"https://bitbucket.org/bestseller-ecom/dmw"},"avatar":{"href":"https://bitbucket.org/bestseller-ecom/dmw/avatar/32/"}},"type":"repository","name":"dmw","full_name":"bestseller-ecom/dmw","uuid":"{5cfe3ae0-fb76-4e76-81e3-67dca1dd9e21}"},"full_name":"ngeor/dmw","has_issues":false,"owner":{"username":"ngeor","display_name":"Nikolaos Georgiou","type":"user","uuid":"{b035c98c-8f83-49d0-8770-95c80cc24dc5}","links":{"self":{"href":"https://api.bitbucket.org/2.0/users/ngeor"},"html":{"href":"https://bitbucket.org/ngeor/"},"avatar":{"href":"https://bitbucket.org/account/ngeor/avatar/32/"}}},"updated_on":"2015-08-26T11:29:49.439808+00:00","size":484231375,"type":"repository","is_private":true,"description":""},{"scm":"git","website":null,"has_wiki":false,"name":"giftcard","links":{"watchers":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/giftcard/watchers"},"branches":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/giftcard/refs/branches"},"tags":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/giftcard/refs/tags"},"commits":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/giftcard/commits"},"clone":[{"href":"https://ngeor@bitbucket.org/ngeor/giftcard.git","name":"https"},{"href":"ssh://git@bitbucket.org/ngeor/giftcard.git","name":"ssh"}],"self":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/giftcard"},"html":{"href":"https://bitbucket.org/ngeor/giftcard"},"avatar":{"href":"https://bitbucket.org/ngeor/giftcard/avatar/32/"},"hooks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/giftcard/hooks"},"forks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/giftcard/forks"},"downloads":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/giftcard/downloads"},"pullrequests":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/giftcard/pullrequests"}},"fork_policy":"no_public_forks","uuid":"{bdb286f3-7250-41b7-95ef-415d02772bfc}","language":"java","created_on":"2015-02-01T07:28:08.374920+00:00","parent":{"links":{"self":{"href":"https://api.bitbucket.org/2.0/repositories/bestseller-ecom/giftcard"},"html":{"href":"https://bitbucket.org/bestseller-ecom/giftcard"},"avatar":{"href":"https://bitbucket.org/bestseller-ecom/giftcard/avatar/32/"}},"type":"repository","name":"giftcard","full_name":"bestseller-ecom/giftcard","uuid":"{95efdd32-15f3-4e1a-a53b-51b52136e2c1}"},"full_name":"ngeor/giftcard","has_issues":false,"owner":{"username":"ngeor","display_name":"Nikolaos Georgiou","type":"user","uuid":"{b035c98c-8f83-49d0-8770-95c80cc24dc5}","links":{"self":{"href":"https://api.bitbucket.org/2.0/users/ngeor"},"html":{"href":"https://bitbucket.org/ngeor/"},"avatar":{"href":"https://bitbucket.org/account/ngeor/avatar/32/"}}},"updated_on":"2015-02-01T07:28:08.489016+00:00","size":26204592,"type":"repository","is_private":true,"description":""},{"scm":"git","website":null,"has_wiki":false,"name":"ProductFeedProcessor","links":{"watchers":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/productfeedprocessor/watchers"},"branches":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/productfeedprocessor/refs/branches"},"tags":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/productfeedprocessor/refs/tags"},"commits":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/productfeedprocessor/commits"},"clone":[{"href":"https://ngeor@bitbucket.org/ngeor/productfeedprocessor.git","name":"https"},{"href":"ssh://git@bitbucket.org/ngeor/productfeedprocessor.git","name":"ssh"}],"self":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/productfeedprocessor"},"html":{"href":"https://bitbucket.org/ngeor/productfeedprocessor"},"avatar":{"href":"https://bitbucket.org/ngeor/productfeedprocessor/avatar/32/"},"hooks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/productfeedprocessor/hooks"},"forks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/productfeedprocessor/forks"},"downloads":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/productfeedprocessor/downloads"},"pullrequests":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/productfeedprocessor/pullrequests"}},"fork_policy":"no_public_forks","uuid":"{2e4bce41-32a4-4990-8843-d9b2c63e0dc3}","language":"","created_on":"2015-03-24T12:16:47.850541+00:00","parent":{"links":{"self":{"href":"https://api.bitbucket.org/2.0/repositories/bestseller-ecom/productfeedprocessor"},"html":{"href":"https://bitbucket.org/bestseller-ecom/productfeedprocessor"},"avatar":{"href":"https://bitbucket.org/bestseller-ecom/productfeedprocessor/avatar/32/"}},"type":"repository","name":"ProductFeedProcessor","full_name":"bestseller-ecom/productfeedprocessor","uuid":"{e3cc2272-cfc3-433b-a198-a32535d7a241}"},"full_name":"ngeor/productfeedprocessor","has_issues":false,"owner":{"username":"ngeor","display_name":"Nikolaos Georgiou","type":"user","uuid":"{b035c98c-8f83-49d0-8770-95c80cc24dc5}","links":{"self":{"href":"https://api.bitbucket.org/2.0/users/ngeor"},"html":{"href":"https://bitbucket.org/ngeor/"},"avatar":{"href":"https://bitbucket.org/account/ngeor/avatar/32/"}}},"updated_on":"2015-04-02T11:53:46.556275+00:00","size":1960900,"type":"repository","is_private":true,"description":""},{"scm":"git","website":null,"has_wiki":false,"name":"oms","links":{"watchers":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/oms/watchers"},"branches":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/oms/refs/branches"},"tags":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/oms/refs/tags"},"commits":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/oms/commits"},"clone":[{"href":"https://ngeor@bitbucket.org/ngeor/oms.git","name":"https"},{"href":"ssh://git@bitbucket.org/ngeor/oms.git","name":"ssh"}],"self":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/oms"},"html":{"href":"https://bitbucket.org/ngeor/oms"},"avatar":{"href":"https://bitbucket.org/ngeor/oms/avatar/32/"},"hooks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/oms/hooks"},"forks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/oms/forks"},"downloads":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/oms/downloads"},"pullrequests":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/oms/pullrequests"}},"fork_policy":"no_public_forks","uuid":"{2daead18-f2f8-4635-a8df-3c746f15d2ec}","language":"","created_on":"2015-03-24T14:10:01.599163+00:00","parent":{"links":{"self":{"href":"https://api.bitbucket.org/2.0/repositories/bestseller-ecom/oms"},"html":{"href":"https://bitbucket.org/bestseller-ecom/oms"},"avatar":{"href":"https://bitbucket.org/bestseller-ecom/oms/avatar/32/"}},"type":"repository","name":"oms","full_name":"bestseller-ecom/oms","uuid":"{2266b951-d697-4650-92eb-76462f92bca4}"},"full_name":"ngeor/oms","has_issues":false,"owner":{"username":"ngeor","display_name":"Nikolaos Georgiou","type":"user","uuid":"{b035c98c-8f83-49d0-8770-95c80cc24dc5}","links":{"self":{"href":"https://api.bitbucket.org/2.0/users/ngeor"},"html":{"href":"https://bitbucket.org/ngeor/"},"avatar":{"href":"https://bitbucket.org/account/ngeor/avatar/32/"}}},"updated_on":"2015-03-26T10:52:14.337447+00:00","size":78093948,"type":"repository","is_private":true,"description":""},{"scm":"git","website":null,"has_wiki":false,"name":"SiteGenesis-Community","links":{"watchers":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/sitegenesis-community/watchers"},"branches":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/sitegenesis-community/refs/branches"},"tags":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/sitegenesis-community/refs/tags"},"commits":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/sitegenesis-community/commits"},"clone":[{"href":"https://ngeor@bitbucket.org/ngeor/sitegenesis-community.git","name":"https"},{"href":"ssh://git@bitbucket.org/ngeor/sitegenesis-community.git","name":"ssh"}],"self":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/sitegenesis-community"},"html":{"href":"https://bitbucket.org/ngeor/sitegenesis-community"},"avatar":{"href":"https://bitbucket.org/ngeor/sitegenesis-community/avatar/32/"},"hooks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/sitegenesis-community/hooks"},"forks":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/sitegenesis-community/forks"},"downloads":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/sitegenesis-community/downloads"},"pullrequests":{"href":"https://api.bitbucket.org/2.0/repositories/ngeor/sitegenesis-community/pullrequests"}},"fork_policy":"no_forks","uuid":"{ca15b031-d438-4bbb-a4d7-e5acb6fb7b2b}","language":"","created_on":"2015-08-04T09:37:02.663550+00:00","parent":{"links":{"self":{"href":"https://api.bitbucket.org/2.0/repositories/demandware/sitegenesis-community"},"html":{"href":"https://bitbucket.org/demandware/sitegenesis-community"},"avatar":{"href":"https://bitbucket.org/demandware/sitegenesis-community/avatar/32/"}},"type":"repository","name":"SiteGenesis-Community","full_name":"demandware/sitegenesis-community","uuid":"{4723f3c4-7de4-4f1d-a03d-6dd6a36aae6e}"},"full_name":"ngeor/sitegenesis-community","has_issues":false,"owner":{"username":"ngeor","display_name":"Nikolaos Georgiou","type":"user","uuid":"{b035c98c-8f83-49d0-8770-95c80cc24dc5}","links":{"self":{"href":"https://api.bitbucket.org/2.0/users/ngeor"},"html":{"href":"https://bitbucket.org/ngeor/"},"avatar":{"href":"https://bitbucket.org/account/ngeor/avatar/32/"}}},"updated_on":"2015-08-04T09:50:46.499812+00:00","size":1189937088,"type":"repository","is_private":true,"description":""}],"page":1,"size":8}

                 */
                while (p.hasNext()) {
                    JsonElement jsonElement = p.next();
                    out.println(jsonElement);
                    JsonObject repositories = jsonElement.getAsJsonObject().getAsJsonObject("values");
                    out.println(repositories);
                }

            } finally {
                httpResponse.close();
            }
        } finally {
            httpClient.close();
        }
    }
}
